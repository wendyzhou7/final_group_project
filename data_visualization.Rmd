---
title: "Data Visualization"
output:
  html_document:
    toc: true
    code_folding: hide
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggridges)
library(patchwork)
library(readxl)
library(lubridate)
library(leaflet)
library(plotly)
library(readr)
library(knitr)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	message = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

Our goal in this project is to visualize and analyze the SARS-CoV-2 concentrations within the 14 waste water facilities located in the New York City. However, the visualization process is not easily achieved as the NYC waste water dataset does not contain longitudinal and latitudinal information about the facilities. In order to successfully map the distribution of wastewater facilities within NYC we need to find a dataset with locational information.We found them in an international dataset "HydroWASTE" which contains the geographic data for waste water facilities in many countries, containing USA. 

- How to create a dataset which contains both SARS-CoV-2 data and geographic location data?
- what is the overall SARS-CoV-2 distribution inside waste water across NYC over the years of the pandemic?
- How does the SARS-CoV-2 concentration vary among the 14 waste water facilities in NYC over the years of the pandemic?
- How does the SARS-CoV-2 concentration distribute within each of the waste water facility over the years of the pandemic?


```{r load the data files}
map <-
  read_csv("data/HydroWASTE_v10.csv")

head(map) %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")

wwtp <-
  read_csv("data/SARS-CoV-2_concentrations_measured_in_NYC_Wastewater_20231129.csv")

wwtp %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")
```
<br />

Load two datasets and decide what varibles we will working with in addition to do data clean and combine it into one dataset called nyc_wastewater.

<br />
```{r clean the mapping data file and rename plant names}
map_df <-
  map |>
  janitor::clean_names() |>
  select(waste_id, wwtp_name, lat_wwtp, lon_wwtp) |>
  mutate(wrrf_abbreviation = recode( wwtp_name,
    "New York C   Rockaway WPCP" = "RK",
    "New York C   Red Hook WPCP" = "RH",
    "New York C   Port Richmond WPCP" = "PR",
    "New York C   Oakwood Beach WPCP" = "OB",
    "New York C   26th Ward WPCP" = "26W",
    "New York C   Tallman Island WPCP" = "TI",
    "New York C   North River WPCP" = "NR",
    "New York C   Coney Island WPCP" = "CI",
    "New York C   Jamaica WPCP" = "JA",
    "New York C   Hunts Point WPCP" = "HP",
    "New York C   Owls Head WPCP" = "OH",
    "New York C   Bowery Bay WPCP" = "BB",
    "New York C   Newtown Creek WPCP" = "NC",
    "New York C   Wards Island WPCP" = "WI",
  ))

wwtp_df <-
  wwtp |>
  janitor:: clean_names()

merge_df <- inner_join(map_df, wwtp_df, by = "wrrf_abbreviation")

nyc_wastewater <-
  merge_df |>
  rename(concentration = concentration_sars_co_v_2_gene_target_n1_copies_l) |>
  drop_na(concentration) |>
  separate(sample_date, into = c("month", "day", "year"), convert = TRUE) %>% 
   mutate(
     year = as.character(year),
     month = factor(month, levels = 1:12),
     month = recode(month,
                        "1" = "January",
                        "2" = "February",
                        "3" = "March",
                        "4" = "April",
                        "5" = "May",
                        "6" = "June",
                        "7" = "July",
                        "8" = "August",
                        "9" = "September",
                        "10" = "October",
                        "11" = "November",
                        "12" = "December")) |>
  select(-waste_id, -test_date, -per_capita_sars_co_v_2_load_n1_copies_per_day_per_population, -population_served_estimated, -wwtp_name, -annotation, -wrrf_abbreviation)

nyc_wastewater %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")
```

<br />

Creating the dataset for an overall trend for Covid-19 concentration across the 14 waste water facilities within New York City from 2020 to 2023.

```{r}
overall_trend <-
  nyc_wastewater |>
  filter(technology == "RT-qPCR") |>
  select(-lat_wwtp, -lon_wwtp) |>
  group_by(year, month) |>
  summarise(avg_conc = mean(concentration)) |>
  unite("year_month",year, month, sep = "_") |>
  mutate(month_avg = ymd(paste0(year_month, "_01")))
```

<br />

### Monthly average Covid-19 concentration in waste water in NY measured from 2020 to 2023

```{r}
overall_trend |>
  ggplot(aes(x = month_avg, y = avg_conc)) + 
  geom_point(size = 3, alpha = .7) +
  geom_smooth(size = 2, se = FALSE, alpha = .3) +
    labs(
      x = "Time", 
      y = "Monthly average Covid-19 concentration in waste water in NY (N/L)") + 
  theme(axis.line = element_line(color = "grey"), 
      panel.background = element_blank(), 
      legend.position = "none", 
      panel.grid.major = element_line(color = "light grey", linetype = "dashed"),
      plot.title = element_text(hjust = 0.5)) + 
  ggtitle("Monthly average Covid-19 concentration in waste water in NY measured from 2020 to 2023")
```

<br />

```{r}
rtqpcr <-
  nyc_wastewater |>
  filter(year %in% c(2021, 2022), technology == "RT-qPCR") |>
  select(-lat_wwtp, -lon_wwtp)

dpcr <-
  nyc_wastewater |>
  filter(year %in% c(2021, 2022), technology == "dPCR") |>
  select(-lat_wwtp, -lon_wwtp)
```


By comparing datasets from different techniques (RT-qPCR and dPCR), we found that "dPCR" had only few observations, which was insufficient for some analysis to show trends in Covid- 19 concentrations. So we decide to use only the dataset with technology "RT-qPCR". Also "RT-qPCR" data for 2020 and 2023 are incomplete, so we only used data from 2021 and 2022 for our analysis.

<br />

### Average Covid-19 Concentration of each waste water facility in 2021 in New York City

```{r}
spaghetti_plot_2021 <-
  rtqpcr |>
  filter(year == 2021) |>
  group_by(month, wrrf_name) |>
  summarise(avg_conc = mean(concentration)) |>
  ggplot(aes(x = month, y = avg_conc, color = wrrf_name, group = wrrf_name)) +
  geom_line(alpha = .5) +
  geom_point(alpha = .5) +
  labs(x = "Month", 
       y = "Mean Covid-19 Concentration", 
       title = "Average Covid-19 Concentration of each waste water facility in 2021 in NYC") + 
  theme(legend.position = "bottom",
        legend.box.background = element_rect(),
        legend.key.size = unit(0.001, 'cm'),
        axis.text.x = element_text(angle = 60, hjust = 1),
        legend.text = element_text(size = 6))

spaghetti_plot_2021
```

<br />

### Average Covid-19 Concentration of each waste water facility in 2022 in New York City

```{r}
spaghetti_plot_2022 <-
  rtqpcr |>
  filter(year == 2022) |>
  group_by(month, wrrf_name) |>
  summarise(avg_conc = mean(concentration)) |>
  ggplot(aes(x = month, y = avg_conc, color = wrrf_name, group = wrrf_name)) +
  geom_line(alpha = .5) +
  geom_point(alpha = .5) +
  labs(x = "Month", 
       y = "Mean Covid-19 Concentration", 
       title = "Average Covid-19 Concentration of each waste water facility in 2022 in NYC",
       color = "Water Facility") + 
  theme(legend.position = "bottom",
        legend.box.background = element_rect(),
        legend.key.size = unit(0.001, 'cm'),
        axis.text.x = element_text(angle = 60, hjust = 1),
        legend.text = element_text(size = 6)) 

spaghetti_plot_2022
```

<br />

### Box Plot for Average Covid-19 Concentration of each waste water facility in 2021 in New York City

```{r}
box_plot_2021 <- rtqpcr %>%
  filter(year == 2021) %>%
  group_by(month, wrrf_name) %>%
  summarise(avg_conc = mean(concentration)) %>%
  plot_ly(
    x = ~avg_conc,
    y = ~wrrf_name,
    type = "box",
    color = ~wrrf_name,
    colors = "viridis"
  ) %>%
  layout(
    xaxis = list(title = "Mean concentration (N/L)"),
    yaxis = list(title = "Area"),
    showlegend = FALSE
  )

box_plot_2021

```

<br />

### Box Plot for Average Covid-19 Concentration of each waste water facility in 2021 in New York City

```{r}
box_plot_2022 <- rtqpcr %>%
  filter(year == 2022) %>%
  group_by(month, wrrf_name) %>%
  summarise(avg_conc = mean(concentration)) %>%
  plot_ly(
    x = ~avg_conc,
    y = ~wrrf_name,
    type = "box",
    color = ~wrrf_name,
    colors = "viridis"
  ) %>%
  layout(
    xaxis = list(title = "Mean concentration (N/L)"),
    yaxis = list(title = "Area"),
    showlegend = FALSE
  )

box_plot_2021
```
