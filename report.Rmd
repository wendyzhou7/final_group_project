---
title: "Final Report"
output:
  html_document:
    toc: true
    code_folding: hide
    toc_float: true
---

## Motivation
<div class="well well-sm">

COVID-19 cases are constantly fluctuating and to better understand recent trends, we decided to analyze SARS-CoV-2 concentrations in wastewater data for the possibility of future public health interventions. New York City is a place with a highly dense population and any known sources of COVID-19 contamination easily affect and spread the disease rapidly. There is an abundance of early days research on the pandemic, but we were interested in the post-pandemic COVID-19 contamination, therefore we decided to look into NYC wastewater, shedding light on potential trends and hotspots.

</div>

<br />

## Related work

<div class="well well-sm">

According to the National Center for Disease and Control (CDC), wastewater surveillance can provide early warnings of COVID-19 spread to communities and to allow for public officials to take action more quickly. It is found that SARS-CoV-2 virus can be transferred to feces, which is a way to detect those who are contaminated even before they start to show symptoms.

</div>

<br />

## Initial questions

<div class="well well-sm">
1. What trends can we see from the NYC wastewater COVID-19 concentrations?
2. Is there a significant difference in NYC COVID-19 wastewater concentrations by season?
3. Is there a significant difference in COVID-19 wastewater concentrations by NYC borough?
4. Are seasons and NYC boroughs a significant predictor of COVID-19 wastewater concentrations?


With our interest in the current COVID-19 climate in NYC, we first create data visualizations to see what trends are apparent. We saw a clear trend in high COVID-19 concentrations in the winter time and lower in the winter times. However, we knew we needed to test this hypothesis to make any conclusions. For the purposes of this project, takign locations into consideration would allow us to demonstrate our data analysis and visualizations skills.

</div>

<br />

## Data 
<br />
### About the data
We used open data sources from 'NYC Open Data' and 'figshare':

* SARS-CoV-2 concentrations measured in NYC Wastewater (NYC Open Data)

* HydroWaste Mapping data (figshare)


For our purposes, we have loaded the following R packages:

* `tidyverse`

* `ggridges`

* `patchwork`

* `readxl`

* `lubridate`

* `leaflet`

* `readr`

* `knitr`

```{r message=FALSE}
library(tidyverse)
library(ggridges)
library(patchwork)
library(readxl)
library(lubridate)
library(leaflet)
library(plotly)
library(readr)
library(knitr)
```


First, we imported the SARS-CoV-2 concentrations measured in NYC Wastewater and HydroWaste mapping data using the read_csv.

Here is a glimpse of the types of variables we have:

```{r message=FALSE}
map <-
  read_csv("data/HydroWASTE_v10.csv")

head(map) %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")
  

wwtp <-
  read_csv("data/SARS-CoV-2_concentrations_measured_in_NYC_Wastewater_20231129.csv")

head(wwtp) %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")
```
<br />

### Data Cleaning
```{r clean the mapping data file and rename plant names}
map_df <-
  map |>
  janitor::clean_names() |>
  select(waste_id, wwtp_name, lat_wwtp, lon_wwtp) |>
  mutate(wrrf_abbreviation = recode( wwtp_name,
    "New York C   Rockaway WPCP" = "RK",
    "New York C   Red Hook WPCP" = "RH",
    "New York C   Port Richmond WPCP" = "PR",
    "New York C   Oakwood Beach WPCP" = "OB",
    "New York C   26th Ward WPCP" = "26W",
    "New York C   Tallman Island WPCP" = "TI",
    "New York C   North River WPCP" = "NR",
    "New York C   Coney Island WPCP" = "CI",
    "New York C   Jamaica WPCP" = "JA",
    "New York C   Hunts Point WPCP" = "HP",
    "New York C   Owls Head WPCP" = "OH",
    "New York C   Bowery Bay WPCP" = "BB",
    "New York C   Newtown Creek WPCP" = "NC",
    "New York C   Wards Island WPCP" = "WI",
  ))
```
<br />

We decided to analyze COVID-19 concentrations from the year 2021 and 2022 as these are recent years and would be most relevant to understand current the COVID cliamte. We are able to create visualizations with the 2023 observations, but we decided to leave it out of our final analysis because data was only taken from January to April of 2023. We focused only on COVID-19 concentrations that were collected using RT-qPCR because dPCR only had about 50 observations (not enough for thorough analysis).

<br />
```{r clean the waste water data file}
wwtp_df <-
  wwtp |>
  janitor:: clean_names()
```
<br />
```{r merge the waste water data file and mapping data file}
merge_df <- inner_join(map_df, wwtp_df, by = "wrrf_abbreviation")
```
<br />
After cleaning, we merged the mapping and wastewater COVID-19 concentrations datasets to `nyc_wastewater`.
```{r choose the variables from the merged data file, message=FALSE}
nyc_wastewater <-
  merge_df |>
  rename(concentration = concentration_sars_co_v_2_gene_target_n1_copies_l) |>
  drop_na(concentration) |>
  separate(sample_date, into = c("month", "day", "year"), convert = TRUE) %>% 
   mutate(
     year = as.character(year),
     month = factor(month, levels = 1:12),
     month = recode(month,
                        "1" = "January",
                        "2" = "February",
                        "3" = "March",
                        "4" = "April",
                        "5" = "May",
                        "6" = "June",
                        "7" = "July",
                        "8" = "August",
                        "9" = "September",
                        "10" = "October",
                        "11" = "November",
                        "12" = "December")) |>
  select(-waste_id, -test_date, -per_capita_sars_co_v_2_load_n1_copies_per_day_per_population, -population_served_estimated, -wwtp_name, -annotation, -wrrf_abbreviation)

head(nyc_wastewater) %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")
```
<br />

The raw mapping dataset has 58503 observations and 25 variables. For our purposes, we only kept 5 variables including waste_id, wttp_name, lat_wttp, long_wttp, and wrrf_abbreviation. The raw wastewater dataset has 4270 observations and 9 variables. For our purposes, we extracted the test date to month, year, and kept wrrf_name, concentration (n1 copies/L), and technology.

Our final merged dataset (mapping and wastewater) for analysis is called **nyc_wastewater** with 4129 observations, and 8 variables. Those include lat_wttp, lon_wttp, month, day, year, wrrf_name, concentration, technology.

<br />

**Data dictionary:**

<div class="well">
* `lat_wttp`: latitude of water facility location

* `lon_wttp`: longitude of water facility location

* `month`: test date (month)

* `day`: test date (day)

* `year`: test date (year)

* `wrrf_name`: Wastewater Resource Recovery Facility (waste water treatment plant) where sample was taken

* `concentration`: Concentration of the N1 target of SARS-CoV2 genetic material measured in wastewater influent.

* `technology`: COVID-19 concentration test detection method (either RT-qPCR or dPCR)
</div>

<br />

Here, we are reating the dataset for an overall trend for Covid-19 concentration across the 14 waste water facilities within New York State from 2020 to 2023.

<br />
```{r message=FALSE, warning=FALSE}
overall_trend <-
  nyc_wastewater |>
  filter(technology == "RT-qPCR") |>
  select(-lat_wwtp, -lon_wwtp) |>
  group_by(year, month) |>
  summarise(avg_conc = mean(concentration)) |>
  unite("year_month",year, month, sep = "_") |>
  mutate(month_avg = ymd(paste0(year_month, "_01")))
```
<br />

Plotting Scatterplot
```{r message=FALSE, warning=FALSE}
overall_trend |>
  ggplot(aes(x = month_avg, y = avg_conc)) + 
  geom_point(size = 3, alpha = .7) +
  geom_smooth(size = 2, se = FALSE, alpha = .3) +
    labs(
      x = "Time", 
      y = "Average Covid-19 concentration (N/L)") + 
  theme(axis.line = element_line(color = "grey"), 
      panel.background = element_blank(), 
      legend.position = "none", 
      panel.grid.major = element_line(color = "light grey", linetype = "dashed"),
      plot.title = element_text(hjust = 0.5)) + 
  ggtitle("Monthly average Covid-19 concentration in waste water in NY measured from 2020 to 2023")
```
<br />
```{r subdatset, message=FALSE}
rtqpcr <-
  nyc_wastewater |>
  filter(year %in% c(2021, 2022), technology == "RT-qPCR") |>
  select(-lat_wwtp, -lon_wwtp)
# rtqpcr dataset with 2387 observations and 6 variables: month, day, year, wrrf_name, concentration, technology

dpcr <-
  nyc_wastewater |>
  filter(year %in% c(2021, 2022), technology == "dPCR") |>
  select(-lat_wwtp, -lon_wwtp)
```


<br />

## Exploratory analysis

Let's take a look at some graphical visualizations to identify any trends.

<br />

### Trends: Spaghetti plots
<br />

#### Average Covid-19 Concentration by location in 2021
```{r message=FALSE}
spaghetti_plot_2021 <-
  rtqpcr |>
  filter(year == 2021) |>
  group_by(month, wrrf_name) |>
  summarise(avg_conc = mean(concentration)) |>
  ggplot(aes(x = month, y = avg_conc, color = wrrf_name, group = wrrf_name)) +
  geom_line(alpha = .5) +
  geom_point(alpha = .5) +
  labs(x = "Month", 
       y = "Mean Covid-19 Concentration", 
       title = "Average Covid-19 Concentration of each waste water facility in 2021 in New York State") + 
  theme(legend.position = "bottom",
        legend.box.background = element_rect(),
        legend.key.size = unit(0.001, 'cm'),
        axis.text.x = element_text(angle = 60, hjust = 1),
        legend.text = element_text(size = 6))

spaghetti_plot_2021
```

<br />

#### Average Covid-19 Concentration by location in 2022
```{r message=FALSE}
spaghetti_plot_2022 <-
  rtqpcr |>
  filter(year == 2022) |>
  group_by(month, wrrf_name) |>
  summarise(avg_conc = mean(concentration)) |>
  ggplot(aes(x = month, y = avg_conc, color = wrrf_name, group = wrrf_name)) +
  geom_line(alpha = .5) +
  geom_point(alpha = .5) +
  labs(x = "Month", 
       y = "Mean Covid-19 Concentration", 
       title = "Average Covid-19 Concentration of each waste water facility in 2022 in New York State",
       color = "Water Facility") + 
  theme(legend.position = "bottom",
        legend.box.background = element_rect(),
        legend.key.size = unit(0.001, 'cm'),
        axis.text.x = element_text(angle = 60, hjust = 1),
        legend.text = element_text(size = 6)) 

spaghetti_plot_2022
```

<br />

### Trends: Boxplots

#### Average Covid-19 Concentration by waste water facility in 2021
```{r message=FALSE}
box_plot_2021 <- rtqpcr %>%
  filter(year == 2021) %>%
  group_by(month, wrrf_name) %>%
  summarise(avg_conc = mean(concentration)) %>%
  plot_ly(
    x = ~avg_conc,
    y = ~wrrf_name,
    type = "box",
    color = ~wrrf_name,
    colors = "viridis"
  ) %>%
  layout(
    xaxis = list(title = "Mean concentration (N/L)"),
    yaxis = list(title = "Area"),
    showlegend = FALSE
  )

box_plot_2021

```

<br />

#### Average Covid-19 Concentration by waste water facility in 2022
```{r message=FALSE}
box_plot_2022 <- rtqpcr |> 
  filter(year == 2022) |> 
  group_by(month, wrrf_name) |> 
  summarise(avg_conc = mean(concentration)) %>%
  plot_ly(
    x = ~avg_conc,
    y = ~wrrf_name,
    type = "box",
    color = ~wrrf_name,
    colors = "viridis"
  ) |> 
  layout(
    xaxis = list(title = "Mean concentration (N/L)"),
    yaxis = list(title = "Area"),
    showlegend = FALSE
  )

box_plot_2021
```
<br />

### Interactive Map

*Visualizations, summaries, and exploratory statistical analyses. Justify the steps you took, and show any major changes to your ideas.*

<br />


## Additional analysis
<br />

### ANOVA

### Logistic Regression

*If you undertake formal statistical analyses, describe these in detail*
Discussion: What were your findings? Are they what you expect? What insights into the data can you make?
As this will be your only chance to describe your project in detail, make sure that your report is a standalone document that fully describes your process and results. We also expect you to write high-quality code that is understandable to an outside reader. Coding collaboratively and actively reviewing code within the team will help with this

